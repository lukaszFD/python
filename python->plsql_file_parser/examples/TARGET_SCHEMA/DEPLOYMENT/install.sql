-- DEPLOYMENT SCRIPT: TARGET_SCHEMA
SET DEFINE OFF;
SET ECHO ON;

PROMPT Deploying APP_SYNC_STATS...
CREATE TABLE "TARGET_SCHEMA"."APP_SYNC_STATS" 
(
    "STAT_ID" NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "TABLE_NAME" VARCHAR2(100),
    "SYNC_DATE" DATE DEFAULT SYSDATE,
    "ROWS_PROCESSED" NUMBER,
    "STATUS" VARCHAR2(20),
    "ERROR_MESSAGE" VARCHAR2(4000)
);

PROMPT Deploying TEST_CTI_INDICATORS...
CREATE TABLE "TARGET_SCHEMA"."TEST_CTI_INDICATORS"
(
    "IOC_ID" NUMBER(*,0),
    "IOC_VALUE" VARCHAR2(500),
    "IOC_TYPE" VARCHAR2(50),
    "MALWARE_FAMILY" VARCHAR2(100),
    "CONFIDENCE_SCORE" NUMBER(3,0),
    "LAST_SEEN" DATE
,
    "INSERTED_ON" DATE DEFAULT SYSDATE
);

PROMPT Deploying TEST_HOME_GUARDIAN_CONFIG...
CREATE TABLE "TARGET_SCHEMA"."TEST_HOME_GUARDIAN_CONFIG"
(
    "CONFIG_ID" NUMBER(*,0),
    "PARAM_NAME" VARCHAR2(255),
    "PARAM_VALUE" VARCHAR2(1000),
    "IS_ENCRYPTED" VARCHAR2(1),
    "UPDATE_BY" VARCHAR2(100)
)
/;

PROMPT Deploying TEST_SENTINEL_THREAT_LOGS...
CREATE TABLE "TARGET_SCHEMA"."TEST_SENTINEL_THREAT_LOGS"
(
    "LOG_ID" NUMBER(*,0),
    "DETECTION_TIME" DATE,
    "THREAT_LEVEL" VARCHAR2(20),
    "SOURCE_IP" VARCHAR2(45),
    "THREAT_DESCRIPTION" VARCHAR2(4000),
    "MITIGATION_STATUS" VARCHAR2(50)
,
    "INSERTED_ON" DATE DEFAULT SYSDATE
);

PROMPT Deploying TEST_VAULT_ACCESS_AUDIT...
CREATE TABLE "TARGET_SCHEMA"."TEST_VAULT_ACCESS_AUDIT"
(
    "AUDIT_ID" NUMBER(*,0),
    "USER_PRINCIPAL" VARCHAR2(255),
    "RESOURCE_PATH" VARCHAR2(1000),
    "ACCESS_TYPE" VARCHAR2(50),
    "AUTH_METHOD" VARCHAR2(100),
    "RESPONSE_CODE" VARCHAR2(10)
,
    "INSERTED_ON" DATE DEFAULT SYSDATE
);

PROMPT Deploying V_TEST_CTI_INDICATORS...
CREATE OR REPLACE VIEW "TARGET_SCHEMA"."V_TEST_CTI_INDICATORS" AS
SELECT * FROM "TARGET_SCHEMA"."TEST_CTI_INDICATORS"
WHERE TRUNC("INSERTED_ON") = TRUNC(SYSDATE);
/
;

PROMPT Deploying V_TEST_HOME_GUARDIAN_CONFIG...
CREATE OR REPLACE VIEW "TARGET_SCHEMA"."V_TEST_HOME_GUARDIAN_CONFIG" AS
SELECT * FROM "TARGET_SCHEMA"."TEST_HOME_GUARDIAN_CONFIG"
WHERE TRUNC("INSERTED_ON") = TRUNC(SYSDATE);
/
;

PROMPT Deploying V_TEST_SENTINEL_THREAT_LOGS...
CREATE OR REPLACE VIEW "TARGET_SCHEMA"."V_TEST_SENTINEL_THREAT_LOGS" AS
SELECT * FROM "TARGET_SCHEMA"."TEST_SENTINEL_THREAT_LOGS"
WHERE TRUNC("INSERTED_ON") = TRUNC(SYSDATE);
/
;

PROMPT Deploying V_TEST_VAULT_ACCESS_AUDIT...
CREATE OR REPLACE VIEW "TARGET_SCHEMA"."V_TEST_VAULT_ACCESS_AUDIT" AS
SELECT * FROM "TARGET_SCHEMA"."TEST_VAULT_ACCESS_AUDIT"
WHERE TRUNC("INSERTED_ON") = TRUNC(SYSDATE);
/
;

PROMPT Deploying PKG_AUDIT_UTILS...
CREATE OR REPLACE PACKAGE "TARGET_SCHEMA"."PKG_AUDIT_UTILS" AS
    PROCEDURE LOG_STATS(p_table_name IN VARCHAR2, p_rows IN NUMBER, p_status IN VARCHAR2, p_error IN VARCHAR2 DEFAULT NULL);
END "PKG_AUDIT_UTILS";
/

CREATE OR REPLACE PACKAGE BODY "TARGET_SCHEMA"."PKG_AUDIT_UTILS" AS
    PROCEDURE LOG_STATS(p_table_name IN VARCHAR2, p_rows IN NUMBER, p_status IN VARCHAR2, p_error IN VARCHAR2 DEFAULT NULL) IS
        PRAGMA AUTONOMOUS_TRANSACTION;
    BEGIN
        INSERT INTO "APP_SYNC_STATS" (TABLE_NAME, ROWS_PROCESSED, STATUS, ERROR_MESSAGE)
        VALUES (p_table_name, p_rows, p_status, p_error);
        COMMIT;
    END LOG_STATS;
END "PKG_AUDIT_UTILS";
/

PROMPT Deploying PKG_SENTINEL_DATA_SYNC...
CREATE OR REPLACE PACKAGE "TARGET_SCHEMA"."PKG_SENTINEL_DATA_SYNC" AS
    PROCEDURE PRC_LOAD_CTI_INDICATORS;
    PROCEDURE PRC_LOAD_HOME_GUARDIAN_CONFIG;
    PROCEDURE PRC_LOAD_SENTINEL_THREAT_LOGS;
    PROCEDURE PRC_LOAD_VAULT_ACCESS_AUDIT;
END "PKG_SENTINEL_DATA_SYNC";
/

CREATE OR REPLACE PACKAGE BODY "TARGET_SCHEMA"."PKG_SENTINEL_DATA_SYNC" AS
    PROCEDURE PRC_LOAD_CTI_INDICATORS IS
        v_rows NUMBER;
    BEGIN
        MERGE INTO "TARGET_SCHEMA"."TEST_CTI_INDICATORS" tgt
        USING "SOURCE_SCHEMA"."CTI_INDICATORS" src
        ON (tgt.IOC_ID = src.IOC_ID AND tgt.IOC_VALUE = src.IOC_VALUE AND tgt.IOC_TYPE = src.IOC_TYPE AND tgt.MALWARE_FAMILY = src.MALWARE_FAMILY AND tgt.CONFIDENCE_SCORE = src.CONFIDENCE_SCORE AND tgt.LAST_SEEN = src.LAST_SEEN)
        WHEN MATCHED THEN
            UPDATE SET 
                tgt.IOC_ID = src.IOC_ID,
                tgt.IOC_VALUE = src.IOC_VALUE,
                tgt.IOC_TYPE = src.IOC_TYPE,
                tgt.MALWARE_FAMILY = src.MALWARE_FAMILY,
                tgt.CONFIDENCE_SCORE = src.CONFIDENCE_SCORE,
                tgt.LAST_SEEN = src.LAST_SEEN
        WHEN NOT MATCHED THEN
            INSERT (IOC_ID, IOC_VALUE, IOC_TYPE, MALWARE_FAMILY, CONFIDENCE_SCORE, LAST_SEEN)
            VALUES (src.IOC_ID, src.IOC_VALUE, src.IOC_TYPE, src.MALWARE_FAMILY, src.CONFIDENCE_SCORE, src.LAST_SEEN);
            
        v_rows := SQL%ROWCOUNT;
        
        "PKG_AUDIT_UTILS".LOG_STATS('TEST_CTI_INDICATORS', v_rows, 'SUCCESS');
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            "PKG_AUDIT_UTILS".LOG_STATS('TEST_CTI_INDICATORS', 0, 'ERROR', SQLERRM);
            ROLLBACK;
            RAISE;
    END PRC_LOAD_CTI_INDICATORS;
    PROCEDURE PRC_LOAD_HOME_GUARDIAN_CONFIG IS
        v_rows NUMBER;
    BEGIN
        MERGE INTO "TARGET_SCHEMA"."TEST_HOME_GUARDIAN_CONFIG" tgt
        USING "SOURCE_SCHEMA"."HOME_GUARDIAN_CONFIG" src
        ON (tgt.CONFIG_ID = src.CONFIG_ID AND tgt.PARAM_NAME = src.PARAM_NAME AND tgt.PARAM_VALUE = src.PARAM_VALUE AND tgt.IS_ENCRYPTED = src.IS_ENCRYPTED AND tgt.UPDATE_BY = src.UPDATE_BY)
        WHEN MATCHED THEN
            UPDATE SET 
                tgt.CONFIG_ID = src.CONFIG_ID,
                tgt.PARAM_NAME = src.PARAM_NAME,
                tgt.PARAM_VALUE = src.PARAM_VALUE,
                tgt.IS_ENCRYPTED = src.IS_ENCRYPTED,
                tgt.UPDATE_BY = src.UPDATE_BY
        WHEN NOT MATCHED THEN
            INSERT (CONFIG_ID, PARAM_NAME, PARAM_VALUE, IS_ENCRYPTED, UPDATE_BY)
            VALUES (src.CONFIG_ID, src.PARAM_NAME, src.PARAM_VALUE, src.IS_ENCRYPTED, src.UPDATE_BY);
            
        v_rows := SQL%ROWCOUNT;
        
        "PKG_AUDIT_UTILS".LOG_STATS('TEST_HOME_GUARDIAN_CONFIG', v_rows, 'SUCCESS');
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            "PKG_AUDIT_UTILS".LOG_STATS('TEST_HOME_GUARDIAN_CONFIG', 0, 'ERROR', SQLERRM);
            ROLLBACK;
            RAISE;
    END PRC_LOAD_HOME_GUARDIAN_CONFIG;
    PROCEDURE PRC_LOAD_SENTINEL_THREAT_LOGS IS
        v_rows NUMBER;
    BEGIN
        MERGE INTO "TARGET_SCHEMA"."TEST_SENTINEL_THREAT_LOGS" tgt
        USING "SOURCE_SCHEMA"."SENTINEL_THREAT_LOGS" src
        ON (tgt.LOG_ID = src.LOG_ID AND tgt.DETECTION_TIME = src.DETECTION_TIME AND tgt.THREAT_LEVEL = src.THREAT_LEVEL AND tgt.SOURCE_IP = src.SOURCE_IP AND tgt.THREAT_DESCRIPTION = src.THREAT_DESCRIPTION AND tgt.MITIGATION_STATUS = src.MITIGATION_STATUS)
        WHEN MATCHED THEN
            UPDATE SET 
                tgt.LOG_ID = src.LOG_ID,
                tgt.DETECTION_TIME = src.DETECTION_TIME,
                tgt.THREAT_LEVEL = src.THREAT_LEVEL,
                tgt.SOURCE_IP = src.SOURCE_IP,
                tgt.THREAT_DESCRIPTION = src.THREAT_DESCRIPTION,
                tgt.MITIGATION_STATUS = src.MITIGATION_STATUS
        WHEN NOT MATCHED THEN
            INSERT (LOG_ID, DETECTION_TIME, THREAT_LEVEL, SOURCE_IP, THREAT_DESCRIPTION, MITIGATION_STATUS)
            VALUES (src.LOG_ID, src.DETECTION_TIME, src.THREAT_LEVEL, src.SOURCE_IP, src.THREAT_DESCRIPTION, src.MITIGATION_STATUS);
            
        v_rows := SQL%ROWCOUNT;
        
        "PKG_AUDIT_UTILS".LOG_STATS('TEST_SENTINEL_THREAT_LOGS', v_rows, 'SUCCESS');
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            "PKG_AUDIT_UTILS".LOG_STATS('TEST_SENTINEL_THREAT_LOGS', 0, 'ERROR', SQLERRM);
            ROLLBACK;
            RAISE;
    END PRC_LOAD_SENTINEL_THREAT_LOGS;
    PROCEDURE PRC_LOAD_VAULT_ACCESS_AUDIT IS
        v_rows NUMBER;
    BEGIN
        MERGE INTO "TARGET_SCHEMA"."TEST_VAULT_ACCESS_AUDIT" tgt
        USING "SOURCE_SCHEMA"."VAULT_ACCESS_AUDIT" src
        ON (tgt.AUDIT_ID = src.AUDIT_ID AND tgt.USER_PRINCIPAL = src.USER_PRINCIPAL AND tgt.RESOURCE_PATH = src.RESOURCE_PATH AND tgt.ACCESS_TYPE = src.ACCESS_TYPE AND tgt.AUTH_METHOD = src.AUTH_METHOD AND tgt.RESPONSE_CODE = src.RESPONSE_CODE)
        WHEN MATCHED THEN
            UPDATE SET 
                tgt.AUDIT_ID = src.AUDIT_ID,
                tgt.USER_PRINCIPAL = src.USER_PRINCIPAL,
                tgt.RESOURCE_PATH = src.RESOURCE_PATH,
                tgt.ACCESS_TYPE = src.ACCESS_TYPE,
                tgt.AUTH_METHOD = src.AUTH_METHOD,
                tgt.RESPONSE_CODE = src.RESPONSE_CODE
        WHEN NOT MATCHED THEN
            INSERT (AUDIT_ID, USER_PRINCIPAL, RESOURCE_PATH, ACCESS_TYPE, AUTH_METHOD, RESPONSE_CODE)
            VALUES (src.AUDIT_ID, src.USER_PRINCIPAL, src.RESOURCE_PATH, src.ACCESS_TYPE, src.AUTH_METHOD, src.RESPONSE_CODE);
            
        v_rows := SQL%ROWCOUNT;
        
        "PKG_AUDIT_UTILS".LOG_STATS('TEST_VAULT_ACCESS_AUDIT', v_rows, 'SUCCESS');
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            "PKG_AUDIT_UTILS".LOG_STATS('TEST_VAULT_ACCESS_AUDIT', 0, 'ERROR', SQLERRM);
            ROLLBACK;
            RAISE;
    END PRC_LOAD_VAULT_ACCESS_AUDIT;
END "PKG_SENTINEL_DATA_SYNC";
/

PROMPT Deploying JOB_PRC_LOAD_CTI_INDICATORS...
BEGIN
    DBMS_SCHEDULER.CREATE_JOB (
        job_name        => '"TARGET_SCHEMA"."JOB_PRC_LOAD_CTI_INDICATORS"',
        job_type        => 'STORED_PROCEDURE',
        job_action      => '"TARGET_SCHEMA"."PKG_SENTINEL_DATA_SYNC"."PRC_LOAD_CTI_INDICATORS"',
        start_date      => SYSTIMESTAMP,
        repeat_interval => 'FREQ=DAILY; BYHOUR=2; BYMINUTE=0',
        enabled         => TRUE,
        comments        => 'Daily sync for TEST_CTI_INDICATORS'
    );
END;
/

PROMPT Deploying JOB_PRC_LOAD_HOME_GUARDIAN_CONFIG...
BEGIN
    DBMS_SCHEDULER.CREATE_JOB (
        job_name        => '"TARGET_SCHEMA"."JOB_PRC_LOAD_HOME_GUARDIAN_CONFIG"',
        job_type        => 'STORED_PROCEDURE',
        job_action      => '"TARGET_SCHEMA"."PKG_SENTINEL_DATA_SYNC"."PRC_LOAD_HOME_GUARDIAN_CONFIG"',
        start_date      => SYSTIMESTAMP,
        repeat_interval => 'FREQ=DAILY; BYHOUR=2; BYMINUTE=0',
        enabled         => TRUE,
        comments        => 'Daily sync for TEST_HOME_GUARDIAN_CONFIG'
    );
END;
/

PROMPT Deploying JOB_PRC_LOAD_SENTINEL_THREAT_LOGS...
BEGIN
    DBMS_SCHEDULER.CREATE_JOB (
        job_name        => '"TARGET_SCHEMA"."JOB_PRC_LOAD_SENTINEL_THREAT_LOGS"',
        job_type        => 'STORED_PROCEDURE',
        job_action      => '"TARGET_SCHEMA"."PKG_SENTINEL_DATA_SYNC"."PRC_LOAD_SENTINEL_THREAT_LOGS"',
        start_date      => SYSTIMESTAMP,
        repeat_interval => 'FREQ=DAILY; BYHOUR=2; BYMINUTE=0',
        enabled         => TRUE,
        comments        => 'Daily sync for TEST_SENTINEL_THREAT_LOGS'
    );
END;
/

PROMPT Deploying JOB_PRC_LOAD_VAULT_ACCESS_AUDIT...
BEGIN
    DBMS_SCHEDULER.CREATE_JOB (
        job_name        => '"TARGET_SCHEMA"."JOB_PRC_LOAD_VAULT_ACCESS_AUDIT"',
        job_type        => 'STORED_PROCEDURE',
        job_action      => '"TARGET_SCHEMA"."PKG_SENTINEL_DATA_SYNC"."PRC_LOAD_VAULT_ACCESS_AUDIT"',
        start_date      => SYSTIMESTAMP,
        repeat_interval => 'FREQ=DAILY; BYHOUR=2; BYMINUTE=0',
        enabled         => TRUE,
        comments        => 'Daily sync for TEST_VAULT_ACCESS_AUDIT'
    );
END;
/

COMMIT;
EXIT;